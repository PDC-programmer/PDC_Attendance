<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>คำขอการลา</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">คำขอการลา</h1>

        <!-- Input UID -->
        <div class="mb-4">
            <label for="user-uid" class="form-label">กรอก UID</label>
            <input type="text" id="user-uid" class="form-control" placeholder="กรอก UID ของคุณ">
            <button id="load-data" class="btn btn-primary mt-3 w-100">โหลดข้อมูล</button>
        </div>

        <!-- Employee Information -->
        <div class="mb-4">
            <h4>ข้อมูลพนักงาน</h4>
            <div class="row">
                <div class="col-6"><strong>ชื่อ:</strong> <span id="employee-name">-</span></div>
                <div class="col-6"><strong>ตำแหน่ง:</strong> <span id="employee-title">-</span></div>
                <div class="col-6"><strong>แผนก:</strong> <span id="employee-department">-</span></div>
                <div class="col-6"><strong>รหัสพนักงาน:</strong> <span id="employee-staff_code">-</span></div>
            </div>
        </div>

        <!-- Leave Balance Table -->
        <div class="mb-4">
            <h4>จำนวนวันลาคงเหลือ</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ประเภทการลา</th>
                        <th>จำนวนวันทั้งหมด</th>
                        <th>วันลาคงเหลือ</th>
                    </tr>
                </thead>
                <tbody id="leave-balance-table">
                    <tr>
                        <td colspan="3" class="text-center">-</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Leave Request History -->
        <div class="mb-4">
            <h4>คำขออนุมัติของคุณ</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>วันที่เริ่มลา</th>
                        <th>ถึงวันที่</th>
                        <th>เหตุผล</th>
                        <th>สถานะ</th>
                    </tr>
                </thead>
                <tbody id="leave-attendance-table">
                    <tr>
                        <td colspan="4" class="text-center">-</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Leave Request Form -->
        <div class="mb-4">
            <h4>คำขอการลา</h4>
            <div class="mb-3">
                <label for="start-date" class="form-label">เริ่มวันที่</label>
                <input type="date" class="form-control" id="start-date">
            </div>
            <div class="mb-3">
                <label for="end-date" class="form-label">ถึงวันที่</label>
                <input type="date" class="form-control" id="end-date">
            </div>
            <div class="mb-3">
                <label for="leave-type" class="form-label">ประเภทการลา</label>
                <select class="form-select" id="leave-type">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="reason" class="form-label">เหตุผล</label>
                <textarea class="form-control" id="reason" rows="3"></textarea>
            </div>
            <button id="submit-request" class="btn btn-primary w-100">ยืนยัน</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // ฟังก์ชันโหลดข้อมูลพนักงาน
            function loadEmployeeData(uid) {
                fetch(`/attendance/get-staff/${uid}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            document.getElementById("employee-name").textContent = "ไม่มีข้อมูล";
                            document.getElementById("employee-title").textContent = "ไม่มีข้อมูล";
                            document.getElementById("employee-department").textContent = "ไม่มีข้อมูล";
                            document.getElementById("employee-staff_code").textContent = "ไม่มีข้อมูล";

                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: data.error,
                            });
                        } else {
                            document.getElementById("employee-name").textContent = `${data.staff_fname} ${data.staff_lname}` || "ไม่มีข้อมูล";
                            document.getElementById("employee-title").textContent = `${data.staff_title}` || "ไม่มีข้อมูล";
                            document.getElementById("employee-department").textContent = data.staff_department || "ไม่มีข้อมูล";
                            document.getElementById("employee-staff_code").textContent = `${data.staff_code}` || "ไม่มีข้อมูล";
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching employee data:", error);
                        document.getElementById("employee-name").textContent = "ไม่มีข้อมูล";
                        document.getElementById("employee-title").textContent = "ไม่มีข้อมูล";
                        document.getElementById("employee-department").textContent = "ไม่มีข้อมูล";
                        document.getElementById("employee-staff_code").textContent = "ไม่มีข้อมูล";
                    });
            }

            // ฟังก์ชันโหลดจำนวนวันลาคงเหลือ
            function loadLeaveBalances(uid) {
                fetch(`/attendance/get-leave-balances/${uid}/`)
                    .then(response => response.json())
                    .then(data => {
                        const tableBody = document.getElementById("leave-balance-table");
                        tableBody.innerHTML = ""; // ล้างตารางเก่า
                        if (data.length > 0) {
                            data.forEach(balance => {
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${balance.leave_type}</td>
                                    <td>${balance.total_days}</td>
                                    <td>${balance.remaining_days}</td>
                                `;
                                tableBody.appendChild(row);
                            });
                        } else {
                            tableBody.innerHTML = `
                                <tr>
                                    <td colspan="3" class="text-center">ไม่มีข้อมูลวันลาคงเหลือ</td>
                                </tr>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching leave balances:", error);
                        document.getElementById("leave-balance-table").innerHTML = `
                            <tr>
                                <td colspan="3" class="text-center">ไม่มีข้อมูลวันลาคงเหลือ</td>
                            </tr>
                        `;
                    });
            }

            // ฟังก์ชันโหลดประวัติคำขอการลา
            function loadLeaveAttendances(uid) {
                fetch(`/attendance/get-leave-attendances/${uid}/`)
                    .then(response => response.json())
                    .then(data => {
                        const tableBody = document.getElementById("leave-attendance-table");
                        tableBody.innerHTML = ""; // ล้างตารางเก่า
                        if (data.length > 0) {
                            data.forEach(attendance => {
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${attendance.start_date}</td>
                                    <td>${attendance.end_date}</td>
                                    <td>${attendance.reason}</td>
                                    <td>${attendance.status}</td>
                                `;
                                tableBody.appendChild(row);
                            });
                        } else {
                            tableBody.innerHTML = `
                                <tr>
                                    <td colspan="4" class="text-center">ไม่มีประวัติคำขอการลา</td>
                                </tr>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching leave attendances:", error);
                        document.getElementById("leave-attendance-table").innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center">ไม่มีประวัติคำขอการลา</td>
                            </tr>
                        `;
                    });
            }

            // โหลดประเภทการลา
            fetch("/attendance/get-leave-types/")
                .then(response => response.json())
                .then(data => {
                    const leaveTypeSelect = document.getElementById("leave-type");
                    leaveTypeSelect.innerHTML = ""; // ล้างตัวเลือกเก่า
                    data.forEach(type => {
                        const option = document.createElement("option");
                        option.value = type.id;
                        option.textContent = type.th_name;
                        leaveTypeSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Error fetching leave types:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถโหลดประเภทการลาได้ !',
                    });
                });

            // เมื่อคลิกปุ่ม "โหลดข้อมูล"
            document.getElementById("load-data").addEventListener("click", function () {
                const uid = document.getElementById("user-uid").value.trim();
                if (!uid) {
                    Swal.fire({
                        icon: 'error',
                        title: 'กรุณากรอก UID',
                        text: 'UID จำเป็นต้องระบุ!',
                    });
                    return;
                }

                // โหลดข้อมูลพนักงานและวันลาคงเหลือ
                loadEmployeeData(uid);
                loadLeaveBalances(uid);
                loadLeaveAttendances(uid);
            });

            // ฟังก์ชันส่งคำขอการลา
            document.getElementById("submit-request").addEventListener("click", function () {
                const uid = document.getElementById("user-uid").value.trim();
                const startDate = document.getElementById("start-date").value;
                const endDate = document.getElementById("end-date").value;
                const leaveType = document.getElementById("leave-type").value;
                const reason = document.getElementById("reason").value;

                if (!uid || !startDate || !endDate || !leaveType || !reason) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ข้อมูลไม่ครบถ้วน...',
                        text: 'กรุณากรอกข้อมูลให้ครบถ้วน !',
                    });
                    return;
                }

                fetch("/attendance/leave-request/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userID: uid, startDate, endDate, type: leaveType, reason }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: data.error,
                        });
                    } else {
                        Swal.fire({
                            icon: 'success',
                            title: 'เสร็จสมบูรณ์',
                            text: 'บันทึกเสร็จสมบูรณ์ !',
                        }).then(() => window.location.reload());
                    }
                })
                .catch(error => console.error("Error submitting leave request:", error));
            });
        });
    </script>
</body>
</html>
