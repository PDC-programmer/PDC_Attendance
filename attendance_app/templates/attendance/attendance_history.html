{% extends "general/base.html" %}
{% block title %}‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô{% endblock %}

{% block content %}
<div class="d-flex justify-content-center align-items-center my-5">
    <div class="container" style="width: 95%;">
        <h1 class="text-center mb-4">üìå ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</h1>

        <!-- üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
        <form method="GET" class="row g-3 mb-3">
            <div class="col-md-4">
                <label class="form-label fw-bold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-md-2 align-self-end">
                <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>
        </form>

        <hr>

        {% if error %}
            <div class="alert alert-danger text-center">{{ error }}</div>
        {% elif records %}
            <button class="btn btn-warning btn-sm mb-3" id="toggleEditMode"><i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>

            <div class="table-responsive">
                <table class="table table-hover mt-4 text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th>‡∏Å‡∏∞‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô‡∏•‡∏≤</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th class="edit-column d-none">‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</th>
                            <th class="edit-column d-none">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th class="edit-column d-none">‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</th>
                            <th class="edit-column d-none">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr>
                            <td><strong>{{ record.date|date:"d/m/Y" }}</strong></td>

                            <!-- üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô -->
                            <td>
                                <span class="badge {% if record.shift_day == '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' %}bg-success{% elif record.shift_day == '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' %}bg-secondary{% else %}bg-danger{% endif %}">
                                    {{ record.shift_day }}
                                </span>
                            </td>

                            <!-- üè∑Ô∏è ‡∏Å‡∏∞‡∏á‡∏≤‡∏ô -->
                            <td>
                                {% if record.shift_name %}
                                    <span class="badge bg-info text-dark">{{ record.shift_name }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <!-- üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô‡∏•‡∏≤ -->
                            <td>
                                {% if record.leave_type %}
                                    <span class="badge bg-warning text-dark" data-bs-toggle="tooltip" title="{{ record.leave_reason }}">
                                        {{ record.leave_type }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <!-- üïí ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ -->
                            <td>
                                {% if record.check_in %}
                                    <small class="text-muted">({{ record.branch_in }})</small>
                                    <span class="badge bg-primary"><i class="bi bi-arrow-right-circle"></i> {{ record.check_in|date:"H:i" }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <!-- ‚úè ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) -->
                            <td class="edit-column d-none">
                                <select class="form-select branch-in">
                                    {% for branch in branches %}
                                        <option value="{{ branch.id }}" {% if branch.brc_sname == record.branch_in %}selected{% endif %}>{{ branch.brc_sname }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <!-- ‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) -->
                            <td class="edit-column d-none">
                                <input type="time" class="form-control check-in-time" value="{{ record.check_in|time:'H:i' }}">
                            </td>

                            <!-- üïí ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å -->
                            <td>
                                {% if record.check_out %}
                                    <small class="text-muted">({{ record.branch_out }})</small>
                                    <span class="badge bg-danger"><i class="bi bi-arrow-left-circle"></i> {{ record.check_out|date:"H:i" }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <!-- ‚úè ‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) -->
                            <td class="edit-column d-none">
                                <select class="form-select branch-out">
                                    {% for branch in branches %}
                                        <option value="{{ branch.id }}" {% if branch.brc_sname == record.branch_out %}selected{% endif %}>{{ branch.brc_sname }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <!-- ‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) -->
                            <td class="edit-column d-none">
                                <input type="time" class="form-control check-out-time" value="{{ record.check_out|time:'H:i' }}">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button class="btn btn-success btn-sm mt-3 d-none" id="saveChanges"><i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

        <!-- ‚úÖ Pagination -->
            <nav aria-label="Pagination">
                <ul class="pagination justify-content-center mt-3">
                    {% if records.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?start_date={{ start_date }}&end_date={{ end_date }}&page={{ records.previous_page_number }}">
                                &laquo;
                            </a>
                        </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">{{ records.number }} / {{ records.paginator.num_pages }}</span>
                    </li>

                    {% if records.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?start_date={{ start_date }}&end_date={{ end_date }}&page={{ records.next_page_number }}">
                                &raquo;
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>

        {% else %}
            <p class="text-center text-muted mt-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"</p>
        {% endif %}
    </div>
</div>

<!-- ‚úÖ JavaScript -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toggleEditBtn = document.getElementById("toggleEditMode");
        const saveChangesBtn = document.getElementById("saveChanges");
        const editColumns = document.querySelectorAll(".edit-column");

        toggleEditBtn.addEventListener("click", function () {
            editColumns.forEach(el => el.classList.toggle("d-none"));
            saveChangesBtn.classList.toggle("d-none");
        });

        saveChangesBtn.addEventListener("click", function () {
            alert("üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            const records = document.querySelectorAll("tbody tr");
            let entries = [];

            records.forEach(row => {
                const date = row.querySelector("td:first-child").innerText.trim();
                const branchIn = row.querySelector(".branch-in").value;
                const checkInTime = row.querySelector(".check-in-time").value;
                const branchOut = row.querySelector(".branch-out").value;
                const checkOutTime = row.querySelector(".check-out-time").value;

                if (checkInTime && checkOutTime) {
                    entries.push({
                        "date": date.split("/").reverse().join("-"), // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD
                        "branch_in": branchIn,
                        "check_in": checkInTime,
                        "branch_out": branchOut,
                        "check_out": checkOutTime
                    });
                }
            });

            if (entries.length === 0) {
                alert("‚ùå ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!");
                return;
            }

            fetch("{% url 'request_edit_time' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ "entries": entries })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    location.reload();
                } else {
                    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            });
        });
    });
</script>

{% endblock %}
