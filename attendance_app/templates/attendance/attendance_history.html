{% extends "general/base.html" %}
{% block title %}‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô{% endblock %}

{% block content %}
<div class="d-flex justify-content-center align-items-center my-5">
    <div class="container" style="width: 95%;">
        <h1 class="text-center mb-4">üìå ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</h1>

        <!-- üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
        <form method="GET" class="row g-3 mb-3" id="search-form">
            <div class="col-md-4">
                <label class="form-label fw-bold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-md-2 align-self-end">
                <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>
        </form>

        <hr>

        {% if error %}
            <div class="alert alert-danger text-center">{{ error }}</div>
        {% elif records %}
            <button class="btn btn-warning btn-sm mb-3" id="toggleEditMode"><i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>

            <div class="table-responsive">
                <table class="table table-hover mt-4 text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 30px;"><input type="checkbox" id="select-all"></th>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th>‡∏Å‡∏∞‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô‡∏•‡∏≤</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th class="edit-column d-none">‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</th>
                            <th class="edit-column d-none">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th class="edit-column d-none">‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</th>
                            <th class="edit-column d-none">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td><strong>{{ record.date|date:"d/m/Y" }}</strong></td>

                            <!-- üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô -->
                            <td>
                                <span class="badge {% if record.shift_day == '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' %}bg-success{% elif record.shift_day == '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' %}bg-secondary{% else %}bg-danger{% endif %}">
                                    {{ record.shift_day }}
                                </span>
                            </td>

                            <!-- üè∑Ô∏è ‡∏Å‡∏∞‡∏á‡∏≤‡∏ô -->
                            <td>
                                {% if record.shift_name %}
                                    <span class="badge bg-info text-dark">{{ record.shift_name }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <!-- üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô‡∏•‡∏≤ -->
                            <td>
                                {% if record.leave_type %}
                                    <span class="badge bg-warning text-dark" data-bs-toggle="tooltip" title="{{ record.leave_reason }}">
                                        {{ record.leave_type }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <!-- üïí ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ -->
                            <td>
                                {% if record.check_in %}
                                    <small class="text-muted">({{ record.branch_in }})</small>
                                    <span class="badge bg-primary"><i class="bi bi-arrow-right-circle"></i> {{ record.check_in|date:"H:i" }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <!-- ‚úè ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) -->
                            <td class="edit-column d-none">
                                <select class="form-select form-select-sm branch-in text-center form-input">
                                    {% for branch in branches %}
                                        <option value="{{ branch.id }}" {% if branch.brc_sname == record.branch_in %}selected{% endif %}>{{ branch.brc_sname }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <!-- ‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) -->
                            <td class="edit-column d-none">
                                <div class="d-flex gap-1">
                                    <small class="text-center">‡∏ä‡∏°./‡∏ô‡∏≤‡∏ó‡∏µ</small>
                                    <select class="form-select form-select-sm check-in-hour text-center form-input">
                                        <option value="" {% if record.check_in and record.check_in.hour == hour %}selected{% endif %}></option>
                                        {% for hour in hours %}
                                            <option value="{{ hour }}" {% if record.check_in and record.check_in.hour == hour %}selected{% endif %}>{{ hour }}</option>
                                        {% endfor %}
                                    </select>

                                    <select class="form-select form-select-sm check-in-minute text-center form-input">
                                        <option value="" {% if record.check_in and record.check_in.minute == minute %}selected{% endif %}></option>
                                        {% for minute in minutes %}
                                            <option value="{{ minute }}" {% if record.check_in and record.check_in.minute == minute %}selected{% endif %}>{{ minute }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </td>

                            <!-- üïí ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å -->
                            <td>
                                {% if record.check_out %}
                                    <small class="text-muted">({{ record.branch_out }})</small>
                                    <span class="badge bg-danger"><i class="bi bi-arrow-left-circle"></i> {{ record.check_out|date:"H:i" }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <!-- ‚úè ‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) -->
                            <td class="edit-column d-none">
                                <select class="form-select form-select-sm branch-out text-center form-input">
                                    {% for branch in branches %}
                                        <option value="{{ branch.id }}" {% if branch.brc_sname == record.branch_out %}selected{% endif %}>{{ branch.brc_sname }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <!-- ‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) -->
                            <td class="edit-column d-none">
                                <div class="d-flex gap-1">
                                    <small class="text-center">‡∏ä‡∏°./‡∏ô‡∏≤‡∏ó‡∏µ</small>
                                    <select class="form-select form-select-sm check-out-hour text-center form-input">
                                        <option value="" {% if record.check_out and record.check_out.hour == hour %}selected{% endif %}></option>
                                        {% for hour in hours %}
                                            <option value="{{ hour }}" {% if record.check_out and record.check_out.hour == hour %}selected{% endif %}>{{ hour }}</option>
                                        {% endfor %}
                                    </select>

                                    <select class="form-select form-select-sm check-out-minute text-center form-input">
                                        <option value="" {% if record.check_out and record.check_out.minute == minute %}selected{% endif %}></option>
                                        {% for minute in minutes %}
                                            <option value="{{ minute }}" {% if record.check_out and record.check_out.minute == minute %}selected{% endif %}>{{ minute }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button class="btn btn-success btn-sm mt-3 d-none" id="saveChanges"><i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

        <!-- ‚úÖ Pagination -->
            <nav aria-label="Pagination">
                <ul class="pagination justify-content-center mt-3">
                    {% if records.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?start_date={{ start_date }}&end_date={{ end_date }}&page={{ records.previous_page_number }}">
                                &laquo;
                            </a>
                        </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">{{ records.number }} / {{ records.paginator.num_pages }}</span>
                    </li>

                    {% if records.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?start_date={{ start_date }}&end_date={{ end_date }}&page={{ records.next_page_number }}">
                                &raquo;
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>

        {% else %}
            <p class="text-center text-muted mt-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"</p>
        {% endif %}
    </div>
</div>

<!-- ‚úÖ JavaScript -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Loading ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
        const searchForm = document.getElementById("search-form");
        if (searchForm) {
            searchForm.addEventListener("submit", function (e) {
                e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ submit ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

                Swal.fire({
                    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...",
                    text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà",
                    icon: "info",
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // ‚úÖ ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å delay ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Swal ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡∏ô
                setTimeout(() => {
                    searchForm.submit();
                }, 200);
            });
        }
        const toggleEditBtn = document.getElementById("toggleEditMode");
        const saveChangesBtn = document.getElementById("saveChanges");
        const editColumns = document.querySelectorAll(".edit-column");

        toggleEditBtn.addEventListener("click", function () {
            editColumns.forEach(el => el.classList.toggle("d-none"));
            saveChangesBtn.classList.toggle("d-none");
        });

        saveChangesBtn.addEventListener("click", function () {
            const records = document.querySelectorAll("tbody tr");
            let entries = [];

            records.forEach(row => {
                const isChecked = row.querySelector(".row-checkbox")?.checked;
                if (!isChecked) return;

                const date = row.querySelector("td:nth-child(2)").innerText.trim();  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô td:nth-child(2) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ checkbox ‡πÄ‡∏û‡∏¥‡πà‡∏°
                const branchIn = row.querySelector(".branch-in").value;
                const branchOut = row.querySelector(".branch-out").value;

                const checkInHour = row.querySelector(".check-in-hour").value;
                const checkInMinute = row.querySelector(".check-in-minute").value;
                const checkOutHour = row.querySelector(".check-out-hour").value;
                const checkOutMinute = row.querySelector(".check-out-minute").value;

                const checkInTime = checkInHour && checkInMinute ? `${checkInHour}:${checkInMinute}` : null;
                const checkOutTime = checkOutHour && checkOutMinute ? `${checkOutHour}:${checkOutMinute}` : null;

                if (checkInTime && checkOutTime) {
                    entries.push({
                        "date": date.split("/").reverse().join("-"),
                        "branch_in": branchIn,
                        "check_in": checkInTime,
                        "branch_out": branchOut,
                        "check_out": checkOutTime
                    });
                }
            });

            if (entries.length === 0) {
                Swal.fire({
                    icon: "warning",
                    title: "‚ö† ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å",
                    text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢ checkbox",
                    confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
                });
                return;
            }

            Swal.fire({
                title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å?",
                text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
                cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...",
                        text: "‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà",
                        icon: "info",
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    fetch("{% url 'request_edit_time' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({ "entries": entries })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
                                text: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤",
                                icon: "success",
                                allowOutsideClick: false,
                                showConfirmButton: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                    setTimeout(() => location.reload(), 1000);
                                }
                            });
                        } else {
                            Swal.fire({
                                icon: "error",
                                title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!",
                                text: data.error || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ",
                                confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        Swal.fire({
                            icon: "error",
                            title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!",
                            text: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ",
                            confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
                        });
                    });
                }
            });
        });
    });
</script>
{% endblock %}
