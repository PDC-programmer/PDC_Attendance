<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>คำขอการลา</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- SweetAlert2 -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">คำขอการลา</h1>
        <!-- Staff Information -->
        <div class="mb-3">
            <h4>ข้อมูลพนักงาน</h4>
            <p><strong>ชื่อ:</strong> <span id="staff-name">Loading...</span></p>
            <p><strong>ตำแหน่ง:</strong> <span id="staff-title">Loading...</span></p>
            <p><strong>แผนก:</strong> <span id="staff-department">Loading...</span></p>
            <p><strong>รหัสพนักงาน:</strong> <span id="staff-code">Loading...</span></p>
        </div>

        <!-- Leave Balances -->
        <div class="mb-3">
            <h4>จำนวนวันลาคงเหลือ</h4>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>ประเภทการลา</th>
                        <th>จำนวนวันทั้งหมด</th>
                        <th>วันลาคงเหลือ</th>
                    </tr>
                </thead>
                <tbody id="leave-balance-table">
                    <tr>
                        <td colspan="3" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- Leave Balances -->
        <div class="mb-3">
            <h4>คำขออนุมัติ</h4>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>ลาวันที่</th>
                        <th>ถึงวันที่</th>
                        <th>เหตุผล</th>
                        <th>สถานะ</th>
                    </tr>
                </thead>
                <tbody id="leave-attendance-table">
                    <tr>
                        <td colspan="3" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ฟอร์มคำขอการลา -->
        <div class="mb-3">
            <label for="start-date" class="form-label">เริ่มวันที่</label>
            <input type="date" class="form-control" id="start-date">
        </div>
        <div class="mb-3">
            <label for="end-date" class="form-label">ถึงวันที่</label>
            <input type="date" class="form-control" id="end-date">
        </div>
        <!-- Leave Types -->
        <div class="mb-3">
            <label for="leave-type" class="form-label">ประเภทการลา</label>
            <select class="form-select" id="leave-type">
                {% for leave in leave_types %}
                <option value="{{ leave.id }}">{{ leave.th_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="reason" class="form-label">เหตุผล</label>
            <textarea class="form-control" id="reason" rows="3"></textarea>
        </div>
        <button id="submit-request" class="btn btn-primary w-100 my-4">ยืนยัน</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const liffId = "2006739665-RZxk3YVm"; // Replace with your LIFF ID

            liff.init({ liffId })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        liff.getProfile()
                            .then(profile => {
                                const userId = profile.userId;

                                // Fetch staff and leave balances
                                fetch(`/attendance/leave-request/?userID=${userId}`)
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.error) {
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'เกิดข้อผิดพลาด',
                                                text: data.error,
                                            });
                                            return;
                                        }

                                        // Update staff information
                                        const staff = data.staff;
                                        document.getElementById("staff-name").textContent = `${staff.staff_fname} ${staff.staff_lname}`;
                                        document.getElementById("staff-title").textContent = staff.staff_title;
                                        document.getElementById("staff-department").textContent = staff.staff_department;
                                        document.getElementById("staff-code").textContent = staff.staff_code;

                                        // Update leave balances table
                                        const leavebalancetableBody = document.getElementById("leave-balance-table");
                                        leavebalancetableBody.innerHTML = "";
                                        data.leave_balances.forEach(balance => {
                                            const row = document.createElement("tr");
                                            row.innerHTML = `
                                                <td>${balance.leave_type}</td>
                                                <td>${balance.total_days}</td>
                                                <td>${balance.remaining_days}</td>
                                            `;
                                            leavebalancetableBody.appendChild(row);
                                        });
                                        // Update leave attendances table
                                        const leaveattendancetableBody = document.getElementById("leave-attendance-table");
                                        leaveattendancetableBody.innerHTML = "";
                                        data.leave_attendances.forEach(attendance => {
                                            const row = document.createElement("tr");
                                            row.innerHTML = `
                                                <td>${attendance.start_date}</td>
                                                <td>${attendance.end_date}</td>
                                                <td>${attendance.reason}</td>
                                                <td>${attendance.status}</td>
                                            `;
                                            leaveattendancetableBody.appendChild(row);
                                        });
                                    })
                                    .catch(error => {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'เกิดข้อผิดพลาด',
                                            text: 'ไม่สามารถดึงข้อมูลพนักงานและวันลาคงเหลือได้',
                                        });
                                        console.error("Error fetching data:", error);
                                    });

                                document.getElementById("submit-request").addEventListener("click", () => {
                                    const startDate = document.getElementById("start-date").value;
                                    const endDate = document.getElementById("end-date").value;
                                    const leaveType = document.getElementById("leave-type").value;
                                    const reason = document.getElementById("reason").value;

                                    // ตรวจสอบข้อมูล
                                    if (!startDate || !endDate || !leaveType || !reason) {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'ข้อมูลไม่ครบถ้วน...',
                                            text: 'กรุณากรอกข้อมูลให้ครบถ้วน !',
                                        });
                                        return;
                                    }

                                    // ตรวจสอบว่า endDate มากกว่า startDate หรือไม่
                                    if (new Date(endDate) < new Date(startDate)) {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'วันที่ไม่ถูกต้อง...',
                                            text: 'วันที่สิ้นสุดต้องไม่น้อยกว่าวันที่เริ่มต้น !',
                                        });
                                        return;
                                    }

                                    // Show loading alert
                                    Swal.fire({
                                        title: 'กำลังบันทึกข้อมูล...',
                                        text: 'กรุณารอสักครู่...',
                                        allowOutsideClick: false,
                                        didOpen: () => {
                                            Swal.showLoading();
                                        }
                                    });

                                    fetch("/attendance/leave-request/", {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                        },
                                        body: JSON.stringify({
                                            userID: userId,
                                            startDate,
                                            endDate,
                                            type: leaveType,
                                            reason,
                                        }),
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        Swal.close(); // Close loading alert
                                        if (data.error) {
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'เกิดข้อผิดพลาด',
                                                text: data.error,
                                            });
                                        } else {
                                            Swal.fire({
                                                icon: 'success',
                                                title: 'เสร็จสมบูรณ์',
                                                text: 'บันทึกเสร็จสมบูรณ์ !',
                                            }).then(function() {
                                            window.location.href = "https://plusdentalclinic-attendance-ec6ce5056c43.herokuapp.com/attendance/leave-request/";
                                            });
                                        }
                                    })
                                    .catch(error => {
                                        Swal.close(); // Close loading alert
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'เกิดข้อผิดพลาด',
                                            text: 'ไม่สามารถบันทึกคำขอการลาได้ !',
                                        });
                                        console.error("Error:", error);
                                    });
                                });
                            })
                            .catch(err => console.error("Error getting profile: ", err));
                    }
                })
                .catch(err => console.error("Error initializing LIFF: ", err));
        });
    </script>
</body>
</html>
