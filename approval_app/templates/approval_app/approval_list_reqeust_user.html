{% extends "general/base.html" %}
{% block title %}‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô{% endblock %}

{% block content %}
<div class="d-flex justify-content-center align-items-center my-5">
    <div class="container " style="width: 95%;">
        <h1 class="text-center">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1>

        <!-- Search & Filter Form -->
        <form method="GET" class="row g-3 mb-3" id="search-form">
            <div class="col-md-3">
                <label for="approval_type" class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠</label>
                <select id="approval_type" name="approval_type" class="form-select">
                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="leave" {% if approval_type_filter == "leave" %}selected{% endif %}>‡∏Ç‡∏≠‡∏•‡∏≤</option>
                    <option value="shift" {% if approval_type_filter == "shift" %}selected{% endif %}>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞</option>
                    <option value="edit_time" {% if approval_type_filter == "edit_time" %}selected{% endif %}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                <select id="status" name="status" class="form-select">
                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="pending" {% if status == "pending" %}selected{% endif %}>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                    <option value="approved" {% if status == "approved" %}selected{% endif %}>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                    <option value="rejected" {% if status == "rejected" %}selected{% endif %}>‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
                    <option value="cancelled" {% if status == "cancelled" %}selected{% endif %}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                </select>
            </div>
            <div class="col-md-2 align-self-end">
                <button type="submit" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>
        </form>

        <hr>

        {% if approvals %}

            <div class="text-start mb-2">
                <button id="cancel-selected" class="btn btn-warning btn-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-hover mt-4">
                    <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠</th>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for approval in approvals %}
                        <tr>
                            <td>
                                <input type="checkbox" class="approve-checkbox"
                                       value="{{ approval.id }}"
                                       {% if approval.status != "pending" %}disabled{% endif %}>
                            </td>
                            <td>
                                {% if approval.approval_type == "leave" %}
                                    <span class="badge bg-info">‡∏Ç‡∏≠‡∏•‡∏≤</span>
                                {% elif approval.approval_type == "shift" %}
                                    <span class="badge bg-warning">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞</span>
                                {% elif approval.approval_type == "edit_time" %}
                                    <span class="badge bg-primary">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡∏á‡∏≤‡∏ô</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if approval.approval_type == "leave" %}
                                    {{ approval.start_datetime|date:"d/m/Y H:i" }} - {{ approval.end_datetime|date:"d/m/Y H:i" }}
                                {% elif approval.approval_type == "shift" %}
                                    {{ approval.date|date:"d/m/Y" }}
                                {% elif approval.approval_type == "edit_time" %}
                                    {{ approval.date|date:"d/m/Y" }}
                                {% endif %}
                            </td>
                            <td>
                                {% if approval.approval_type == "leave" %}
                                    {{ approval.leave_type.th_name }}
                                {% elif approval.approval_type == "shift" %}
                                    {{ approval.get_shift_day_display }} ({{ approval.shift.name }} ‡∏ô.)
                                {% elif approval.approval_type == "edit_time" %}
                                    {{ approval.timestamp|time:"H:i" }} ‡∏ô. ({{ approval.branch.brc_sname }})
                                {% endif %}
                            </td>
                            <td>
                                {% if approval.status == "pending" %}
                                    <span class="badge bg-secondary">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                                {% elif approval.status == "approved" %}
                                    <span class="badge bg-success">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                                {% elif approval.status == "cancelled" %}
                                    <span class="badge bg-warning">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
                                {% else %}
                                    <span class="badge bg-danger">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- ‚úÖ Pagination -->
            <nav aria-label="Pagination">
                <ul class="pagination justify-content-center mt-3">
                    {% if approvals.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?approval_type=&status={{status}}&page={{ approvals.previous_page_number }}">&laquo;</a>
                        </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">{{ approvals.number }} / {{ approvals.paginator.num_pages }}</span>
                    </li>

                    {% if approvals.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?approval_type=&status={{status}}&page={{ approvals.next_page_number }}">&raquo;</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% else %}
            <p class="text-center text-muted mt-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>
        {% endif %}
    </div>
</div>

<!-- ‚úÖ SweetAlert & jQuery -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function () {
    $("#search-form").on("submit", function (e) {
    e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

    Swal.fire({
        title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...",
        text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà",
        icon: "info",
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏™‡∏î‡∏á loading ‡πÅ‡∏•‡πâ‡∏ß
    setTimeout(() => {
        e.target.submit();  // ‡πÉ‡∏ä‡πâ native form submit
    }, 200); // ‡πÄ‡∏û‡∏¥‡πà‡∏° delay ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ Swal ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÅ‡∏ô‡πà ‡πÜ
});

    $("#select-all").change(function () {
        $(".approve-checkbox:not(:disabled)").prop("checked", $(this).prop("checked"));
    });

    function cancelApprovals() {
        let selected = $(".approve-checkbox:checked").map(function() {
            return $(this).val();
        }).get();

        if (selected.length === 0) {
            Swal.fire("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", "warning");
            return;
        }

        Swal.fire({
            title: "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å?",
            text: "‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
            cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
        }).then((result) => {
            if (result.isConfirmed) {
                // üîÑ ‡πÅ‡∏™‡∏î‡∏á loading ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥ AJAX
                Swal.fire({
                    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠...",
                    text: "‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà",
                    icon: "info",
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                $.ajax({
                    url: "{% url 'bulk_cancel_requests' %}",
                    method: "POST",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                    data: JSON.stringify({ approval_ids: selected }),
                    contentType: "application/json",
                    success: function (response) {
                            Swal.fire({
                                title: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
                                text: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤",
                                icon: "success",
                                allowOutsideClick: false,
                                showConfirmButton: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                    setTimeout(() => location.reload(), 100);
                                }
                            });
                        },
                    error: function () {
                        Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ", "error");
                    }
                });
            }
        });
    }

    $("#cancel-selected").click(() => cancelApprovals());
});
</script>
{% endblock %}
